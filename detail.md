
# detail.md — 细节实现与必须包含的核心优势

## 技术栈与理由

* **语言**：Rust（首选）

  * 性能、高安全性、编译后单文件分发、跨平台支持
* **核心依赖**（示例）

  * tokio：异步网络
  * clap：CLI 参数解析
  * serde / toml / yaml：配置与订阅解析
  * reqwest：HTTP 订阅/测速
  * base64：订阅解码

## 核心模块设计

1. **CLI 层**

   * 参数解析、配置文件路径、订阅输入、日志级别、--daemon 等
2. **订阅解析器**

   * 支持常见机场格式（clash、v2ray、trojan、ss 等）
   * 解码、去重、基本健康检查
3. **节点探测与排序（Node Scoring）**

   * 延迟 RTT 测试（ICMP/UDP/TCP 握手视节点支持）
   * 丢包率、带宽基线测试（轻量化采样）
   * 地理/ASN 标签（用于地区匹配）
   * 实时评分：综合延迟、丢包、可用带宽、稳定性分数、最近成功率
4. **游戏识别与流量绑定**

   * 进程名/路径/命令行匹配
   * 端口集合匹配
   * 可选：用户手动指派 IP/域名 白名单
5. **流量转发引擎（代理内核）**

   * TCP/UDP 转发
   * 支持 UDP 转发与保持会话映射（NAT 映射表）
   * 支持常见代理协议（通过插件或内部实现）：socks5、shadowsocks、vmess/vless（通过已有实现绑定）
6. **智能路由与故障切换逻辑**

   * 选择最优节点并建立隧道
   * 心跳检测，自动快速切换到次优节点
   * 切换平滑策略（小心数据丢失，尽量保持会话）
7. **监控与日志**

   * 实时指标：延迟、丢包、带宽利用、切换次数
   * Prometheus metrics 输出（可选）
8. **安全与隐私**

   * 配置文件与密钥本地加密存储（可选）
   * 最低权限原则（尽量避免驱动、管理员权限）

## 节点来源与管理

* 支持机场订阅导入（解析多种格式）
* 支持自建节点模板与导入脚本（自动化部署脚本示例）
* 节点质量池：定期检测并标记“优/良/差”

## 协议与传输选择建议

* **优先 UDP**（对延迟敏感的游戏）
* 当 UDP 无法使用时，优先选用 VMess/VLESS over UDP 或 QUIC（若可用）
* 为节省开销，尽量复用已有成熟实现（例如 lib-shadowsocks、v2ray-core 的轻量绑定或移植）而非从零实现复杂传输协议

## 性能优化点

* 单线程 async reactor + 少量工作线程模型（减少线程切换）
* 最小化内存分配（使用固定内存池）
* 零拷贝读写与缓冲区重用
* 限制规则集（只处理与游戏相关的流量）

## 测试计划

* 单机性能基准（不同并发连接 / UDP包率）
* 与 Clash Verge/Clash 的对比测试（相同节点下延迟/CPU/内存）
* 稳定性测试（72小时长负载）
* 切换场景测试（节点失活、网络波动）

## 部署与发布

* 打包：交叉编译为 Windows / macOS 二进制
* 配置管理：支持 YAML/TOML 配置与一键导入订阅 URL
* 文档：PROFILE 模板、快速上手、节点质量诊断工具

